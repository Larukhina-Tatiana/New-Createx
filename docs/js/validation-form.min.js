const getStorageKey=e=>"form-storage:"+(e.getAttribute("name")||e.id||"default");document.addEventListener("DOMContentLoaded",(()=>{new class{selectors={form:"[data-js-form]",fieldErrors:"[data-js-form-field-errors]"};errorMessages={valueMissing:()=>"Пожалуйста, заполните это поле",patternMismatch:({title:e})=>e||"Неверный формат данных",tooShort:({minLength:e})=>`Минимум символов — ${e}`,tooLong:({maxLength:e})=>`Максимум символов — ${e}`};constructor(){this.bindEvents(),this.bindAccessibility()}bindAccessibility(){document.querySelectorAll(this.selectors.form).forEach((e=>{const t=e.getAttribute("name")||e.id||"form";e.querySelectorAll("[required]").forEach((r=>{const o=r.getAttribute("name");if(!o)return;const s=e.querySelector(`#${t}-${o}-error`)||r.closest("label")?.querySelector(this.selectors.fieldErrors)||r.closest("fieldset")?.querySelector(this.selectors.fieldErrors);if(s){const e=s.id||`${t}-${o}-error`;s.id=e,r.setAttribute("aria-errormessage",e)}}))}))}manageErrors(e,t){const r=e.getAttribute("aria-errormessage");if(!r)return;const o=document.getElementById(r);o&&(o.innerHTML=t.map((e=>`<span class="form-error">${e}</span>`)).join(""))}validateRadioGroup(e){const t=[],r=e.closest(this.selectors.form),o=e.name,s=r.querySelectorAll(`input[name="${o}"]`);if(![...s].some((e=>e.required)))return!0;const a=[...s].some((e=>e.checked)),n=e.closest(".form__fields-inner");return a||t.push("Пожалуйста, выберите предпочтительный способ связи"),n&&n.classList.toggle("is-invalid",!a),s.forEach((e=>{e.setAttribute("aria-invalid",String(!a))})),this.manageErrors(s[0],t),a}validateField(e){const t=[],r=e.validity,o="SELECT"===e.tagName;o&&e.required&&!e.value&&t.push("Пожалуйста, выберите локацию"),o||Object.entries(this.errorMessages).forEach((([o,s])=>{r[o]&&t.push(s(e))}));const s=0===t.length;if(e.setAttribute("aria-invalid",!s),e.classList.toggle("is-valid",s),e.classList.toggle("is-invalid",!s),o){const t=e.closest(".choices")?.querySelector(".choices__inner");t&&(t.classList.toggle("is-valid",s),t.classList.toggle("is-invalid",!s))}return this.manageErrors(e,t),s}onBlur(e){const{target:t}=e;t.closest(this.selectors.form)&&t.required&&("radio"===t.type?this.validateRadioGroup(t):this.validateField(t))}onChange(e){const{target:t}=e;t.closest(this.selectors.form)&&t.required&&("radio"===t.type?this.validateRadioGroup(t):["select-one","checkbox"].includes(t.type)&&this.validateField(t))}onSubmit(e){const t=e.target;if(!t.matches(this.selectors.form))return;e.preventDefault();const r=getStorageKey(t),o=[...t.elements].filter((e=>e.required));let s=!0,a=null;const n=new Set;if(o.forEach((e=>{let t;if("radio"===e.type){if(n.has(e.name))return;t=this.validateRadioGroup(e),n.add(e.name)}else t=this.validateField(e);t||(s=!1,a||(a=e))})),s){let e=null;try{e=localStorage.getItem(r)}catch(e){console.error("Ошибка чтения из localStorage:",e)}const o=e?JSON.parse(e):{},s={};for(let e in o){const t=o[e];s[e]="string"==typeof t?t.replace(/^\s+|\s+$/g,"").replace(/\n{2,}/g,"\n").trim():t}console.log("✅ Отправка данных:",s),t.reset();const a=t.querySelector(".js-policy-checkbox");a&&(a.checked=!0);try{localStorage.removeItem(r)}catch(e){console.error("Ошибка удаления из localStorage:",e)}createAlertBox(t)}else a?.focus()}bindEvents(){document.addEventListener("blur",(e=>this.onBlur(e)),!0),document.addEventListener("change",(e=>this.onChange(e))),document.addEventListener("submit",(e=>this.onSubmit(e)))}},document.querySelectorAll("[data-js-form]").forEach((e=>{const t=getStorageKey(e),r=({target:e})=>{const{name:r,type:o,value:s,checked:a}=e;if(!r)return;let n={};try{n=JSON.parse(localStorage.getItem(t))||{}}catch(e){return void console.error("Ошибка чтения из localStorage:",e)}if("checkbox"===o)n[r]=a;else{const e=s.replace(/\n{2,}/g,"\n").trim();e?n[r]=e:delete n[r]}if(0===Object.keys(n).length)try{localStorage.removeItem(t)}catch(e){console.error("Ошибка удаления из localStorage:",e)}else try{localStorage.setItem(t,JSON.stringify(n))}catch(e){console.error("Ошибка записи в localStorage:",e)}};e.addEventListener("input",r),e.addEventListener("change",r)})),document.querySelectorAll("[data-js-form]").forEach((e=>{const t=getStorageKey(e);let r=null;try{r=localStorage.getItem(t)}catch(e){console.error("Ошибка чтения из localStorage:",e)}if(!r)return;const o=JSON.parse(r);for(let t in o){const r=e.elements[t];if(r)if(r.length&&"radio"===r[0]?.type){const e=[...r].find((e=>e.value===o[t]));e&&(e.checked=!0,e.dispatchEvent(new Event("change",{bubbles:!0})))}else"checkbox"===r.type?(r.checked=o[t],r.dispatchEvent(new Event("change",{bubbles:!0}))):(r.value=o[t],"SELECT"===r.tagName&&r.dispatchEvent(new Event("change",{bubbles:!0})))}})),document.querySelectorAll("[data-js-form]").forEach(((e,t)=>{if("undefined"==typeof IMask)return void console.warn("IMask не подключён, маска телефона не будет работать.");const r=e.querySelector("[data-js-phone]"),o=e.querySelector(".progress-line");r&&"undefined"!=typeof IMask&&(IMask(r,{mask:"+{38} (000) 000-00-00"}),r.addEventListener("input",(function(){const e=this.value.length,t=this.offsetWidth;o&&(o.style.width=t/19*e+"px",o.style.backgroundColor=`rgb(${255-255/19*e},137,0)`)})),r.addEventListener("blur",(()=>{o&&(o.style.display="none")})),r.addEventListener("focus",(()=>{o&&(o.style.display="block")})))})),document.querySelectorAll("[data-js-form]").forEach((e=>{const t=e.querySelector(".js-policy-checkbox"),r=e.querySelector("[data-js-submit]");t&&r&&(r.disabled=!t.checked,t.addEventListener("change",(e=>{r.disabled=!e.currentTarget.checked})))}))}));